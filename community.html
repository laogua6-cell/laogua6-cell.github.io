<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>éš”å£è€ç“œç¤¾åŒº</title>

<style>
    :root {
        --theme-blue: #4C8DF5;
        --bg: #F2F3F7;
        --card-bg: #ffffff;
        --border-radius: 14px;
        --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    body {
        font-family: 'Segoe UI', Arial;
        background: var(--bg);
        margin: 0;
    }

    header {
        background: var(--theme-blue);
        color: white;
        padding: 18px;
        font-size: 26px;
        text-align: center;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #container {
        width: 95%;
        max-width: 1100px;
        margin: 25px auto;
    }

    button.btn {
        padding: 10px 18px;
        background: var(--theme-blue);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: var(--shadow);
        transition: 0.2s;
    }
    button.btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    /* è¾“å…¥æ¡†æ ·å¼ */
    input, textarea {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin: 8px 0;
        font-size: 15px;
        background: #fff;
        transition: 0.2s;
    }

    input:focus, textarea:focus {
        border-color: var(--theme-blue);
        box-shadow: 0 0 0 3px rgba(76,141,245,0.2);
        outline: none;
    }

    .post-box {
        background: var(--card-bg);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        animation: fadeIn 0.3s ease;
    }

    /* Masonry ç€‘å¸ƒæµå¸ƒå±€ */
    #posts {
        column-count: 3;
        column-gap: 20px;
    }
    @media (max-width: 900px) { #posts { column-count: 2; } }
    @media (max-width: 600px) { #posts { column-count: 1; } }

    .post {
        break-inside: avoid;
        background: var(--card-bg);
        margin-bottom: 20px;
        padding: 18px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        animation: fadeIn 0.4s ease;
    }

    .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 10px;
        box-shadow: var(--shadow);
    }

    .post-time {
        font-size: 13px;
        color: #888;
        margin-top: 3px;
    }

    .comments {
        margin-top: 12px;
        padding-left: 15px;
        border-left: 3px solid #E7E7E7;
    }

    .comment {
        background: #FAFAFA;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 8px;
        border: 1px solid #eee;
        font-size: 14px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

</head>
<body>

<header>éš”å£è€ç“œç¤¾åŒº ğŸ‰</header>

<div id="container">

    <button class="btn" onclick="chooseFolder()">é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹ï¼ˆéš”å£è€ç“œï¼‰</button>
    <p id="folderStatus" style="color:green;font-weight:bold;"></p>

    <div class="post-box">
        <h3 style="margin-top:0;">âœï¸ å‘å¸ƒæ–°å¸–å­</h3>
        <input id="avatarUrl" placeholder="å¤´åƒé“¾æ¥ï¼ˆå¯ä¸å¡«ï¼‰">
        <textarea id="postText" placeholder="è¯·è¾“å…¥å†…å®¹..."></textarea>
        <input id="imgLink" placeholder="å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰">
        <button class="btn" onclick="publishPost()">å‘å¸ƒ</button>
    </div>

    <div id="posts"></div>

</div>

<script>
let folderHandle = null;

// é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹
async function chooseFolder() {
    folderHandle = await window.showDirectoryPicker();
    document.getElementById("folderStatus").innerText =
        "å·²é€‰æ‹©æ–‡ä»¶å¤¹ï¼š" + folderHandle.name;

    loadPosts();
}

function uid() {
    return "post_" + Date.now();
}

// å‘å¸ƒå¸–å­
async function publishPost() {
    if (!folderHandle) return alert("è¯·é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹ï¼");

    const text = document.getElementById("postText").value.trim();
    if (!text) return;

    const post = {
        id: uid(),
        avatar: document.getElementById("avatarUrl").value.trim(),
        text: text,
        image: document.getElementById("imgLink").value.trim(),
        time: new Date().toLocaleString(),
        comments: []
    };

    const fileHandle = await folderHandle.getFileHandle(post.id + ".json", { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(post, null, 2));
    await writable.close();

    addPostToUI(post);

    document.getElementById("postText").value = "";
    document.getElementById("imgLink").value = "";
}

// è¯»å–å¸–å­
async function loadPosts() {
    if (!folderHandle) return;
    const postsDiv = document.getElementById("posts");
    postsDiv.innerHTML = "";

    for await (const entry of folderHandle.values()) {
        if (entry.kind === "file" && entry.name.endsWith(".json")) {
            const file = await entry.getFile();
            const post = JSON.parse(await file.text());
            addPostToUI(post);
        }
    }
}

// æ¸²æŸ“å¸–å­
function addPostToUI(post) {
    const postsDiv = document.getElementById("posts");

    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
        <div style="display:flex; align-items:center;">
            ${post.avatar ? `<img src="${post.avatar}" class="avatar">` : ""}
            <div>
                <strong>åŒ¿åç”¨æˆ·</strong>
                <div class="post-time">${post.time}</div>
            </div>
        </div>

        <p style="margin:12px 0; font-size:15px;">${post.text}</p>

        ${post.image ? 
        `<p style="font-size:14px;">
            <strong>å›¾ç‰‡ï¼š</strong>
            <a href="${post.image}" target="_blank">${post.image}</a>
        </p>` : ""}

        <input id="cmt_${post.id}" placeholder="å†™è¯„è®º..." style="margin-top:8px;">
        <button class="btn" style="margin-top:8px;" onclick="addComment('${post.id}')">è¯„è®º</button>

        <div class="comments" id="comments_${post.id}">
            ${post.comments.map(c => `<div class="comment">${c}</div>`).join("")}
        </div>
    `;

    postsDiv.prepend(div);
}

// æ·»åŠ è¯„è®º
async function addComment(postId) {
    if (!folderHandle) return alert("è¯·é€‰æ‹©æ–‡ä»¶å¤¹ï¼");

    const input = document.getElementById("cmt_" + postId);
    const text = input.value.trim();
    if (!text) return;

    const fileHandle = await folderHandle.getFileHandle(postId + ".json");
    const file = await fileHandle.getFile();
    const post = JSON.parse(await file.text());

    post.comments.push(text);

    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(post, null, 2));
    await writable.close();

    document.getElementById("comments_" + postId).innerHTML += 
        `<div class="comment">${text}</div>`;

    input.value = "";
}
</script>

</body>
</html>